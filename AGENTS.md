# AGENTS.md

## Project Overview
This repository contains a mixed OCaml/Rust project where Rust bindings are exposed to OCaml. Understanding this hybrid nature is essential when working with the codebase.

## Environment Constraints
- You are operating in an offline environment without internet access
- ALWAYS add `--offline` flag to all cargo commands
- Do not attempt to modify or update dependencies as they cannot be downloaded
- Do not try to install new packages or dependencies

## Code Style & Formatting
- Always format Rust code before submitting changes: `cargo fmt --all`
- All Clippy warnings must be fixed (they are treated as errors in CI)
- Use automatic fixing when possible: `cargo clippy --fix --all --offline --allow-dirty -- -D warnings`
- Always format Rust code before submitting changes: `opam exec -- dune fmt`

## Testing Requirements
- Run Rust tests with: `cargo test --offline`
- Run OCaml integration tests with: `opam exec -- dune runtest`
- Both test suites must pass for any changes
- Rust tests focus on internal functionality within the Rust domain
- OCaml tests verify end-to-end integration between Rust and OCaml

## Build Process
1. Format code: `cargo fmt --all`/`opam exec -- dune fmt`
2. Fix linting issues: `cargo clippy --fix --all --offline --allow-dirty -- -D warnings`
3. Run Rust tests: `cargo test --offline`
4. Build OCaml components: `opam exec -- dune build`
5. Run OCaml tests: `opam exec -- dune runtest`

### Generating `lib/Stubs.ml`

`lib/Stubs.ml` is generated by stubs-gen binary. To update it's contents you
need to run `dune runtest` with auto-promotion on `lib` folder as follows:

```
$ dune runtest lib --auto-promote
File "lib/Stubs.ml", line 1, characters 0-0:
------ lib/Stubs.ml
++++++ lib/Stubs.ml.new
<.... some diff will be here ....>
Promoting _build/default/lib/Stubs.ml.new to lib/Stubs.ml.
```

### Generating `test/Stubs.ml`

Same as above, `dune runtest test --auto-promote` should update `test/Stubs.ml`.
This can also trigger running of the tests, but even if tests fail, dune should
promote new `Stubs.ml` as long as stubs re-generation was successful.

### Generating stubs manually

If you run into problems with dune auto-promotion, or you want to just build the
new stubs without doing anything else - you can generate stubs explicitly with
the following commands:

```
$ dune build stubs-gen/{Ocaml_lwt_interop.ml,Ocaml_lwt_interop_test_stubs.ml}
$ ocamlformat -i _build/default/stubs-gen/{Ocaml_lwt_interop.ml,Ocaml_lwt_interop_t
est_stubs.ml}
$ cp _build/default/stubs-gen/Ocaml_lwt_interop.ml lib/Stubs.ml 
$ cp _build/default/stubs-gen/Ocaml_lwt_interop_test_stubs.ml test/Stubs.ml
```

## PR Instructions
- Title format: [Component] Brief description
- Include a "Testing Done" section that lists verification steps performed
- Ensure all tests pass locally before submission

## Git Commit Best Practices

**Atomic and Focused Commits**

- Each commit should represent a single logical change - avoid mixing unrelated changes in one commit. This makes it easier to review, revert, and understand the project history.

**Descriptive Commit Messages**

- Write clear, concise subject lines (ideally 50 characters or less) that summarize the change. Avoid vague messages like "fix bug".
- Use the imperative mood in the subject line (e.g., "Add test for Rust bindings" instead of "Added test for Rust bindings").
- Capitalize the first letter of the subject line and do not end it with a period.
- Separate the subject from the body with a blank line.
- If needed, include a detailed body (wrapped at 72 characters per line) explaining the "what" and "why" of the change. Focus on the reasoning and context, not implementation details.
- Reference related issues or pull requests in the body or footer for traceability (e.g., "Fixes \#123").

**Commit Organization and Consistency**

- Make small, specific commits. This helps with code review and makes it easier to revert changes if necessary.
- Scope commits to a single feature, bug fix, or refactor. Donâ€™t leave the codebase in a broken state between commits.
- Organize commits into a logical narrative that tells the story of your changes.
- Test and verify code before committing to ensure the commit does not break the build or tests.

**Conventional Commit Guidelines**

- Consider following the [Conventional Commits](https://www.conventionalcommits.org/) specification for consistency:
    - Prefix the subject with a type (e.g., `feat:`, `fix:`, `docs:`, `refactor:`).
    - Optionally include a scope in parentheses (e.g., `feat(auth): add JWT-based authentication`).
- Example:

```
feat(rust): add offline cargo test support
```


**Commit Message Structure Example**

```
Fix OCaml/Rust integration test runner

Ensure that the offline flag is correctly passed to all cargo commands.
This prevents network calls in CI and local environments without internet.
Fixes #42.
```

**Additional Tips**

- Avoid including unrelated fixes or changes in a single commit, even if they seem minor.
- Use commit message templates to encourage consistent structure and clarity.
- Push commits early and often to avoid losing work and to facilitate collaboration.

